<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
	</head>
	<style type="text/css">
		button {
			width: 100px;
			height: 50px;
			line-height: 50px;
			font-size: 18px;
			border-radius: 10px;
			background: none;
			border: 1px solid gray;
		}
	</style>

	<body>
		<button id="the-button">Try it 41!</button>
		<button class="stopNotifications">停止监听</button>
	</body>

</html>
<script src="http://localhost:8080/target/target-script-min.js#anonymous"></script>
<script type="text/javascript">
	// const debug = document.querySelector('#the-button');
	var button = document.querySelector('#the-button');
	var blug = document.querySelector('.blug')
	var appdevice;
	var ServiceUuid = 0xFFE0;
	var CharactUuid = 0xFFE1;

	function textEncoder(value) {
		var encoder = new TextEncoder('utf-8');
		value = encoder.encode(value)
		return value
	}
	button.addEventListener('click', function() {
	console.log('=========')
	try {
	console.log(navigator.bluetooth);
	navigator.bluetooth.requestDevice({
			filters: [{
				services: [ServiceUuid]
			}],

			// acceptAllDevices: true
		})
		.then(function(device) {

			appdevice = device;
			// navigator.bluetooth
			console.log(appdevice)

			console.log("开始连接");
			alert('开始连接')
			return appdevice.gatt.connect()
		})
		.then(function(server) {
			try{
				console.log("连接成功开始扫描服务", server);
				alert("连接成功开始扫描服务", server);
				return server.getPrimaryService(ServiceUuid)
			}catch(e){
				alert(e)
			}
		})
		.then(function(services) {
				console.log("=====", services)
				//    console.log("services[0]",services[0])
				return Promise.all([
					services.getCharacteristics(CharactUuid)
					.then(function(res) {
						console.log('Characteristic:', res)
						alert('Characteristic:'+res)
						res[0].writeValue(textEncoder(11))
							.then(function() {
								console.log('写入成功')
								alert('写入成功')
							})
						res[0].startNotifications().then(function() {
							console.log('开始监听通知')
							res[0].addEventListener('characteristicvaluechanged', function(success) {
								console.log('监听到了改变事件'+success+','+success)
								var arr=[]
								for(var key in success)
								{
									arr.push(success[key])
								}
								console.log(arr)
								res[0].writeValue(textEncoder(22))
								document.querySelector('.stopNotifications').addEventListener('click',function(){
									res[0].stopNotifications().then(function(){
										console.log('停止监听通知按钮已经开启')
									})
								})
							})
							})
						
					})	
				])
			})

		} catch(e) {
				console.log(false)
				alert(false)
		}

	});
</script>
